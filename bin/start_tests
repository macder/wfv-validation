#!/bin/bash
#
# Interactive menu driven testing

declare DATABASE=(
  "wordpress_test" # DB Name
  "root"           # DB User
  "root"           # DB Pass
  "localhost"      # DB Host
)

declare WORDPRESS=(
  "4.7.3"          # WordPress Ver
  true             # Create DB
)

declare SSH_TUNNEL=(
  "5555"           # Local Inbound Port
  "127.0.0.1"      # Localhost IP
  "3306"           # Local Outbound Port
  "vagrant"        # Remote User
  "192.168.33.10"  # Remote Host
)

declare MENU_MAIN=(
  "MAIN MENU"
  "SSH Tunnel For Remote DB"
  "Start WordPress Testing Instance"
  "Run Tests"
)

declare MENU_DATABASE=(
  "DATABASE"
  "NAME: "${DATABASE[0]}
  "USER: "${DATABASE[1]}
  "PASS: "${DATABASE[2]}
)

declare MENU_SSH_TUNNEL=(
  "SSH TUNNEL"
  "Open Tunnel: ssh "${SSH_TUNNEL[0]}":"${SSH_TUNNEL[1]}":"${SSH_TUNNEL[2]}" "${SSH_TUNNEL[3]}"@"${SSH_TUNNEL[4]}
)

declare MENU_WORDPRESS=(
  "WORDPRESS"
  "Start"
)

declare MENU_TESTS=(
  "UNIT TESTS"
  "ALL"
  "Input"
  "Form"
  "Validator"
)

RED='\033[0;41;30m'
STD='\033[0;0;39m'


#######################################
# Read input from the keyboard, store it in 'choice'
# Globals:
#   choice
# Arguments:
#   None
# Returns:
#   None
#######################################
read_options(){
  items_in_menu=$1
  read -p "Enter choice [ 1 - $items_in_menu ] " choice
}

#######################################
#
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
menu_main() {
  CURRENT_MENU=("${MENU_MAIN[@]}")
  show_menu CURRENT_MENU
  read_options $item_count

  case $choice in
    1) menu_ssh ;;
    2) menu_wordpress ;;
    3) menu_tests ;;
    4) exit 0 ;;
    *) echo -e "${RED}void choice${STD}" && sleep 0.1
  esac
}

#######################################
#
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
menu_database() {
  CURRENT_MENU=("${MENU_DATABASE[@]}")
  show_menu CURRENT_MENU
  read_options $item_count
}

#######################################
#
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
menu_ssh() {
  CURRENT_MENU=("${MENU_SSH_TUNNEL[@]}")
  show_menu CURRENT_MENU
  read_options $item_count

  case $choice in
    1) clear; ssh -f -N -L 5555:127.0.0.1:3306 vagrant@192.168.33.10; pause ;;
    2) exit 0 ;;
    0) menu_main ;;
    *) echo -e "${RED}void choice${STD}" && sleep 0.1
  esac
}

#######################################
#
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
menu_wordpress() {
  CURRENT_MENU=("${MENU_WORDPRESS[@]}")
  show_menu CURRENT_MENU
  read_options $item_count

  case $choice in
    1) clear; bash lib/install_wp_tests.sh wordpress_test root root 127.0.0.1:5555 latest true; pause ;;
    2) exit 0 ;;
    0) menu_main ;;
    *) echo -e "${RED}void choice${STD}" && sleep 0.1
  esac
}

#######################################
#
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
menu_tests() {
  CURRENT_MENU=("${MENU_TESTS[@]}")
  show_menu CURRENT_MENU

  read_options $item_count

  case $choice in
    1) clear; bash lib/run_test.sh; pause ;;
    2) clear; bash lib/run_test.sh InputTest; pause ;;
    3) clear; bash lib/run_test.sh FormTest; pause ;;
    4) clear; bash lib/run_test.sh ValidatorTest; pause ;;
    5) exit 0 ;;
    0) menu_main ;;
    *) echo -e "${RED}void choice${STD}" && sleep 0.1
  esac
}

#######################################
#
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
pause(){
  read -p "Press [Enter] key to continue..." EnterKey
}


#######################################
# Display menus
# Globals:
#
# Arguments:
#   None
# Returns:
#   None
#######################################
show_menu() {
  local -n MENU_ITEMS="$1"
  MENU_NAME=${MENU_ITEMS[0]}
  bash lib/menu.sh "${MENU_ITEMS[@]}"
  item_count=${#MENU_ITEMS[@]}
}


MENU_NAME=("MAIN MENU")
while true
do
  case $MENU_NAME in
    "MAIN MENU") menu_main ;;
    "DATABASE") menu_database ;;
    "SSH TUNNEL") menu_ssh ;;
    "WORDPRESS") menu_ssh ;;
    "UNIT TESTS") menu_tests ;;
  esac
done
